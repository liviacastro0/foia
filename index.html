<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://github.com/liviacastro0/imgs/blob/main/logo.png?raw=true" type="image/png">
  <link rel="stylesheet" href="style.css">
  <title>Análise de Solo Agrícola - IA Especializada</title>
</head>

<body>
  <div class="container">
    <h1>Análise de Solo Agrícola Inteligente</h1>

    <form id="form-solo" onsubmit="return processarFormulario(event)">
      <div class="form-grid">
        <div class="form-group">
          <label for="nitrogenio">
            Nitrogênio (kg/ha)
            <span class="info-icon" title="Valor ideal: 20-50 kg/ha para maioria das culturas">i</span>
          </label>
          <input type="number" id="nitrogenio" name="nitrogenio" placeholder="Ex: 25" min="0" max="80" required />
          <span class="input-hint">Faixa: 0-80 kg/ha</span>
        </div>

        <div class="form-group">
          <label for="fosforo">
            Fósforo (kg/ha)
            <span class="info-icon" title="Valor ideal: 15-40 kg/ha para grãos">i</span>
          </label>
          <input type="number" id="fosforo" name="fosforo" placeholder="Ex: 15" min="0" max="80" required />
          <span class="input-hint">Faixa: 0-80 kg/ha</span>
        </div>

        <div class="form-group">
          <label for="potassio">
            Potássio (kg/ha)
            <span class="info-icon" title="Valor ideal: 40-80 kg/ha para frutíferas">i</span>
          </label>
          <input type="number" id="potassio" name="potassio" placeholder="Ex: 50" min="0" max="80" required />
          <span class="input-hint">Faixa: 0-80 kg/ha</span>
        </div>

        <div class="form-group">
          <label for="temperatura">
            Temperatura (°C)
            <span class="info-icon" title="Temperatura média anual do local">i</span>
          </label>
          <input type="number" id="temperatura" name="temperatura" placeholder="Ex: 23" min="-25" max="80" required />
          <span class="input-hint">Faixa: -25°C a 80°C</span>
        </div>

        <div class="form-group">
          <label for="umidade">
            Umidade (%)
            <span class="info-icon" title="Umidade relativa média do solo">i</span>
          </label>
          <input type="text" id="umidade" name="umidade" placeholder="Ex: 60,00" required />
          <span class="input-hint">Formato: 00,00 (0-100%)</span>
        </div>

        <div class="form-group">
          <label for="ph">
            pH do Solo
            <span class="info-icon" title="Escala de 0 (ácido) a 14 (alcalino)">i</span>
          </label>
          <input type="text" id="ph" name="ph" placeholder="Ex: 6,50" required />
          <span class="input-hint">Escala: 0 (ácido) a 14 (alcalino)</span>
        </div>
      </div>

      <div class="form-group">
        <label for="chuva">
          Precipitação (mm/mês)
          <span class="info-icon" title="Média mensal de chuva na região">i</span>
        </label>
        <input type="text" id="chuva" name="chuva" placeholder="Ex: 120,000" required />
        <span class="input-hint">Formato: 000,000</span>
      </div>

      <div class="form-group">
        <label for="regiao">
          Região/Clima
          <span class="info-icon" title="Selecione o bioma predominante">i</span>
        </label>
        <select id="regiao" name="regiao" required>
          <option value="">Selecione...</option>
          <option value="Amazônia">Amazônia</option>
          <option value="Cerrado">Cerrado</option>
          <option value="Mata Atlântica">Mata Atlântica</option>
          <option value="Caatinga">Caatinga</option>
          <option value="Pampa">Pampa</option>
          <option value="Pantanal">Pantanal</option>
        </select>
      </div>

      <div style="text-align: center; margin-top: 25px;">
        <button type="submit" id="submit-btn">
          <span id="btn-text">Analisar Solo</span>
          <span class="loading-spinner" id="spinner"></span>
        </button>
        <button type="button" id="btn-ajuda" style="background: #6c757d;">
          Ajuda com Valores
        </button>
      </div>
    </form>

    <table id="tabela-referencia">
      <thead>
        <tr>
          <th>Cultura</th>
          <th>pH Ideal</th>
          <th>N (kg/ha)</th>
          <th>P (kg/ha)</th>
          <th>K (kg/ha)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Soja</td>
          <td>6.0-7.0</td>
          <td>20-40</td>
          <td>15-30</td>
          <td>30-60</td>
        </tr>
        <tr>
          <td>Milho</td>
          <td>5.8-7.0</td>
          <td>30-50</td>
          <td>20-40</td>
          <td>40-80</td>
        </tr>
        <tr>
          <td>Café</td>
          <td>5.5-6.5</td>
          <td>30-50</td>
          <td>20-40</td>
          <td>40-70</td>
        </tr>
        <tr>
          <td>Feijão</td>
          <td>5.8-6.5</td>
          <td>15-30</td>
          <td>10-25</td>
          <td>20-50</td>
        </tr>
      </tbody>
    </table>

    <section id="respostaIA" class="resposta-ia" aria-live="polite" hidden>
      <h2>Recomendações Personalizadas</h2>
      <div id="conteudoResposta"></div>
    </section>
  </div>

  <script>
    const dadosBiomas = {
      "Amazônia": {
        "bioma": "Amazônia",
        "caracteristicas": {
          "area_km2": 5500000,
          "precipitacao_mm_ano": 2500,
          "temperatura_media_c": 26
        },
        "solos": [
          {
            "tipo": "Latossolo Amarelo",
            "textura": "argilosa",
            "ph_medio": 4.5,
            "materia_organica_percent": 3.2,
            "nutrientes_kg_ha": {
              "N": 12,
              "P": 8,
              "K": 25
            },
            "aptidao": "cacau, açaí, guaraná, pupunha"
          },
          {
            "tipo": "Argissolo",
            "textura": "franco-arenosa",
            "ph_medio": 5.2,
            "aptidao": "mandioca, banana, cupuaçu"
          }
        ]
      },
      "Cerrado": {
        "bioma": "Cerrado",
        "caracteristicas": {
          "area_km2": 2040000,
          "precipitacao_mm_ano": 1500,
          "temperatura_media_c": 24
        },
        "solos": [
          {
            "tipo": "Latossolo Vermelho",
            "textura": "média",
            "ph_medio": 5.8,
            "materia_organica_percent": 2.5,
            "nutrientes_kg_ha": {
              "N": 15,
              "P": 12,
              "K": 35
            },
            "aptidao": "soja, milho, algodão, sorgo"
          },
          {
            "tipo": "Neossolo Quartzarênico",
            "textura": "arenosa",
            "ph_medio": 6.2,
            "aptidao": "pastagens, eucalipto"
          }
        ]
      },
      "Mata Atlântica": {
        "bioma": "Mata Atlântica",
        "caracteristicas": {
          "area_km2": 1116000,
          "precipitacao_mm_ano": 1800,
          "temperatura_media_c": 22
        },
        "solos": [
          {
            "tipo": "Terra Roxa",
            "textura": "argilosa",
            "ph_medio": 6.0,
            "materia_organica_percent": 3.8,
            "nutrientes_kg_ha": {
              "N": 18,
              "P": 15,
              "K": 45
            },
            "aptidao": "café, cana-de-açúcar, eucalipto"
          },
          {
            "tipo": "Cambissolo",
            "textura": "franco",
            "ph_medio": 5.5,
            "aptidao": "banana, citrus, hortaliças"
          }
        ]
      },
      "Caatinga": {
        "bioma": "Caatinga",
        "caracteristicas": {
          "area_km2": 844453,
          "precipitacao_mm_ano": 600,
          "temperatura_media_c": 28
        },
        "solos": [
          {
            "tipo": "Luvissolo",
            "textura": "argilosa",
            "ph_medio": 7.2,
            "materia_organica_percent": 0.8,
            "nutrientes_kg_ha": {
              "N": 8,
              "P": 5,
              "K": 18
            },
            "aptidao": "manga, uva irrigada"
          },
          {
            "tipo": "Neossolo Flúvico",
            "textura": "franco-arenosa",
            "ph_medio": 6.8,
            "aptidao": "feijão-caupi, capim buffel"
          }
        ]
      },
      "Pampa": {
        "bioma": "Pampa",
        "caracteristicas": {
          "area_km2": 176496,
          "precipitacao_mm_ano": 1200,
          "temperatura_media_c": 18
        },
        "solos": [
          {
            "tipo": "Planossolo",
            "textura": "média",
            "ph_medio": 6.5,
            "materia_organica_percent": 3.0,
            "nutrientes_kg_ha": {
              "N": 20,
              "P": 18,
              "K": 50
            },
            "aptidao": "arroz, trigo, soja, pastagens"
          },
          {
            "tipo": "Chernossolo",
            "textura": "franco-argilosa",
            "ph_medio": 6.8,
            "aptidao": "vinhas, frutíferas temperadas"
          }
        ]
      },
      "Pantanal": {
        "bioma": "Pantanal",
        "caracteristicas": {
          "area_km2": 150355,
          "precipitacao_mm_ano": 1300,
          "temperatura_media_c": 26
        },
        "solos": [
          {
            "tipo": "Gleissolo",
            "textura": "argilosa",
            "ph_medio": 6.2,
            "materia_organica_percent": 4.5,
            "nutrientes_kg_ha": {
              "N": 25,
              "P": 20,
              "K": 60
            },
            "aptidao": "arroz, pecuária, pesca"
          },
          {
            "tipo": "Neossolo Flúvico",
            "textura": "franco",
            "ph_medio": 6.5,
            "aptidao": "capim nativo, pastagens"
          }
        ]
      }
    };

    // Dados de textura do solo
    const texturasSolo = {
      "texturas": [
        {
          "tipo": "arenosa",
          "composicao": {
            "areia_percent": 85,
            "silte_percent": 10,
            "argila_percent": 5
          },
          "caracteristicas": {
            "retencao_agua": "baixa",
            "aereacao": "alta",
            "fertilidade": "baixa"
          }
        },
        {
          "tipo": "franco-arenosa",
          "composicao": {
            "areia_percent": 65,
            "silte_percent": 20,
            "argila_percent": 15
          },
          "caracteristicas": {
            "retencao_agua": "média",
            "aereacao": "média",
            "fertilidade": "média"
          }
        },
        {
          "tipo": "franco",
          "composicao": {
            "areia_percent": 40,
            "silte_percent": 40,
            "argila_percent": 20
          },
          "caracteristicas": {
            "retencao_agua": "boa",
            "aereacao": "boa",
            "fertilidade": "alta"
          }
        },
        {
          "tipo": "argilosa",
          "composicao": {
            "areia_percent": 20,
            "silte_percent": 30,
            "argila_percent": 50
          },
          "caracteristicas": {
            "retencao_agua": "alta",
            "aereacao": "baixa",
            "fertilidade": "média a alta"
          }
        }
      ]
    };

    function getDadosBioma(bioma) {
      if (!bioma || !dadosBiomas[bioma]) return null;
      return dadosBiomas[bioma];
    }

    function getTexturaSolo(tipoTextura) {
      return texturasSolo.texturas.find(textura => textura.tipo === tipoTextura) || null;
    }

    function aplicarMascaraComVirgula(campoId, maxValor) {
      const campo = document.getElementById(campoId);
      campo.addEventListener('input', function() {
        let valor = campo.value.replace(',', '').replace(/[^\d]/g, '');
        if (valor.length > 2) {
          valor = valor.slice(0, valor.length - 2) + ',' + valor.slice(-2);
        }
        campo.value = valor;
        const valorConvertido = parseFloat(campo.value.replace(',', '.'));
        if (valorConvertido > maxValor) {
          campo.value = maxValor.toFixed(2).replace('.', ',');
        }
        validarCampo(campo);
      });
    }

    function mascaraChuva(campoId) {
      const campo = document.getElementById(campoId);
      campo.addEventListener('input', function() {
        let valor = campo.value.replace(/[^\d]/g, '');
        if (valor.length > 6) valor = valor.slice(0, 6);

        while (valor.length < 4) {
          valor = '0' + valor;
        }

        let parteInteira = valor.slice(0, valor.length - 3);
        let parteDecimal = valor.slice(-3);
        campo.value = `${parseInt(parteInteira)},${parteDecimal}`;
        validarCampo(campo);
      });
    }

    function limitarValor(campoId, min, max) {
      const campo = document.getElementById(campoId);
      campo.addEventListener('input', function() {
        let valor = parseInt(campo.value);
        if (isNaN(valor)) return;
        if (valor > max) campo.value = max;
        if (valor < min) campo.value = min;
        validarCampo(campo);
      });
    }

    function validarCampo(campo) {
      if (campo.value === "") {
        campo.classList.add("erro-validacao");
        campo.classList.remove("sucesso-validacao");
      } else {
        campo.classList.remove("erro-validacao");
        campo.classList.add("sucesso-validacao");
      }
    }

    function validarDadosAgricolas(dados) {
      const erros = [];
      
      if (dados.nitrogenio > 80 || dados.nitrogenio < 0) erros.push("Nitrogênio fora da faixa (0-80 kg/ha)");
      if (dados.fosforo > 80 || dados.fosforo < 0) erros.push("Fósforo fora da faixa (0-80 kg/ha)");
      if (dados.potassio > 80 || dados.potassio < 0) erros.push("Potássio fora da faixa (0-80 kg/ha)");
      if (dados.temperatura > 80 || dados.temperatura < -25) erros.push("Temperatura fora da faixa (-25°C a 80°C)");
      
      const ph = parseFloat(dados.ph.replace(',', '.'));
      if (ph < 0 || ph > 14) erros.push("pH inválido (deve estar entre 0 e 14)");
      
      const umidade = parseFloat(dados.umidade.replace(',', '.'));
      if (umidade < 0 || umidade > 100) erros.push("Umidade deve ser entre 0% e 100%");
      
      if (!dados.regiao) erros.push("Selecione uma região/clima");

      return erros;
    }

    function calcularCalagem(phAtual, phDesejado, textura) {
      // Fatores de correção baseados na textura do solo
      const fatoresTextura = {
        "arenosa": 0.5,
        "franco-arenosa": 0.7,
        "franco": 1.0,
        "argilosa": 1.3
      };
      
      const fator = fatoresTextura[textura] || 1.0;
      const necessidade = (phDesejado - phAtual) * 2000 * fator;
      
      return Math.max(0, Math.round(necessidade));
    }

    function calcularAdubacaoNutriente(nutrienteAtual, nutrienteIdeal, fatorConversao = 1.0) {
      const deficiencia = nutrienteIdeal - nutrienteAtual;
      if (deficiencia <= 0) return 0;
      return Math.round(deficiencia * fatorConversao);
    }

    function getCulturasRecomendadas(bioma, ph, nutrientes) {
      const culturasBase = {
        "Amazônia": ["Cacau", "Açaí", "Guaraná", "Pupunha", "Mandioca"],
        "Cerrado": ["Soja", "Milho", "Algodão", "Sorgo", "Feijão"],
        "Mata Atlântica": ["Café", "Cana-de-açúcar", "Eucalipto", "Banana", "Citrus"],
        "Caatinga": ["Manga", "Uva irrigada", "Caju", "Goiaba", "Feijão-caupi"],
        "Pampa": ["Arroz", "Trigo", "Soja", "Pastagens", "Videiras"],
        "Pantanal": ["Arroz", "Pecuária", "Piscicultura", "Capim", "Pastagens"]
      };
      
      // Filtra culturas baseadas no pH
      const phMinMax = {
        "Cacau": [5.0, 6.5],
        "Açaí": [4.5, 6.5],
        "Soja": [6.0, 7.0],
        "Milho": [5.8, 7.0],
        "Café": [5.5, 6.5],
        "Manga": [5.5, 7.5],
        "Arroz": [5.0, 7.0],
        // Adicione mais culturas conforme necessário
      };
      
      let culturasDisponiveis = culturasBase[bioma] || [];
      
      // Ordena por compatibilidade com pH
      culturasDisponiveis.sort((a, b) => {
        const aPh = phMinMax[a] || [5.0, 7.0];
        const bPh = phMinMax[b] || [5.0, 7.0];
        
        const aDiff = Math.max(0, aPh[0] - ph) + Math.max(0, ph - aPh[1]);
        const bDiff = Math.max(0, bPh[0] - ph) + Math.max(0, ph - bPh[1]);
        
        return aDiff - bDiff;
      });
      
      return {
        principal: culturasDisponiveis[0] || "Soja",
        alternativa: culturasDisponiveis[1] || "Milho",
        outras: culturasDisponiveis.slice(2, 5) || ["Feijão", "Pastagens"]
      };
    }

    async function processarFormulario(event) {
      event.preventDefault();

      const dados = {
        nitrogenio: parseInt(document.getElementById('nitrogenio').value),
        fosforo: parseInt(document.getElementById('fosforo').value),
        potassio: parseInt(document.getElementById('potassio').value),
        temperatura: parseInt(document.getElementById('temperatura').value),
        umidade: document.getElementById('umidade').value,
        ph: document.getElementById('ph').value,
        chuva: document.getElementById('chuva').value,
        regiao: document.getElementById('regiao').value
      };

      const erros = validarDadosAgricolas(dados);
      if (erros.length > 0) {
        alert("Erros encontrados:\n\n" + erros.join("\n"));
        return false;
      }

      document.getElementById('spinner').style.display = 'inline-block';
      document.getElementById('btn-text').textContent = 'Processando...';
      document.getElementById('submit-btn').disabled = true;

      const respostaIA = document.getElementById("respostaIA");
      const conteudoResposta = document.getElementById("conteudoResposta");
      respostaIA.hidden = false;
      conteudoResposta.innerHTML = `
        <div style="text-align:center;margin:2em 0;">
          <div class="loader" style="display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;"></div>
          <p>Consultando especialista agrícola...</p>
        </div>
      `;

      // Simulamos um delay para parecer que está processando
      setTimeout(() => {
        try {
          const dadosBioma = getDadosBioma(dados.regiao);
          const ph = parseFloat(dados.ph.replace(',', '.'));
          const umidade = parseFloat(dados.umidade.replace(',', '.'));
          const chuva = parseFloat(dados.chuva.replace(',', '.'));
          
          // Determina o solo mais adequado baseado nos dados
          let soloPrincipal = dadosBioma?.solos?.[0] || {};
          if (dadosBioma?.solos?.length > 1) {
            // Tenta encontrar o solo com pH mais próximo do informado
            soloPrincipal = dadosBioma.solos.reduce((prev, curr) => {
              const prevDiff = Math.abs((prev.ph_medio || 6.0) - ph);
              const currDiff = Math.abs((curr.ph_medio || 6.0) - ph);
              return prevDiff < currDiff ? prev : curr;
            });
          }
          
          const texturaSolo = getTexturaSolo(soloPrincipal.textura);
          
          // Gera recomendações
          const recomendacoes = [];
          
          // Calagem
          if (ph < 5.5) {
            const phDesejado = 6.0;
            const calcario = calcularCalagem(ph, phDesejado, soloPrincipal.textura);
            recomendacoes.push(`Aplicação de ${calcario} kg/ha de calcário dolomítico para elevar pH de ${ph.toFixed(1)} para ${phDesejado.toFixed(1)}`);
          } else if (ph > 7.5) {
            recomendacoes.push("Solo alcalino, considerar aplicação de gesso agrícola (1-2 ton/ha) para reduzir sódio");
          }
          
          // Adubação nitrogenada
          const N = calcularAdubacaoNutriente(dados.nitrogenio, 30, 1.5);
          if (N > 0) {
            recomendacoes.push(`Adubação nitrogenada: ${N} kg/ha de N (uréia: ${Math.round(N/0.45)} kg/ha)`);
          }
          
          // Adubação fosfatada
          const P = calcularAdubacaoNutriente(dados.fosforo, 20, 1.8);
          if (P > 0) {
            recomendacoes.push(`Adubação fosfatada: ${P} kg/ha de P2O5 (superfosfato simples: ${Math.round(P/0.18)} kg/ha)`);
          }
          
          // Adubação potássica
          const K = calcularAdubacaoNutriente(dados.potassio, 50, 1.2);
          if (K > 0) {
            recomendacoes.push(`Adubação potássica: ${K} kg/ha de K2O (cloreto de potássio: ${Math.round(K/0.60)} kg/ha)`);
          }
          
          // Manejo de umidade
          if (umidade < 40) {
            recomendacoes.push("Solo com baixa umidade, considerar irrigação complementar (20-30mm/semana)");
          } else if (umidade > 80) {
            recomendacoes.push("Solo com excesso de umidade, avaliar drenagem (valas ou camalhões)");
          }
          
          // Culturas recomendadas
          const culturas = getCulturasRecomendadas(dados.regiao, ph, {
            N: dados.nitrogenio,
            P: dados.fosforo,
            K: dados.potassio
          });
          
          // Época de plantio
          let epocaPlantio = "Durante a estação chuvosa";
          if (dados.temperatura > 25) {
            epocaPlantio = "No início das chuvas (outubro/novembro)";
          } else if (dados.temperatura < 15) {
            epocaPlantio = "Na primavera (setembro/outubro)";
          }
          
          // Monta a resposta
          let respostaHTML = `
            <div class="diagnostico-container">
              <h3>1. Diagnóstico do Solo</h3>
              <div class="diagnostico-grid">
                <div class="diagnostico-col">
                  <h4>Nutrientes</h4>
                  <ul>
                    <li>Nitrogênio (N): ${dados.nitrogenio} kg/ha <span class="${dados.nitrogenio < 20 ? 'badge-error' : 'badge-success'}">${dados.nitrogenio < 20 ? 'Baixo' : 'Adequado'}</span></li>
                    <li>Fósforo (P): ${dados.fosforo} kg/ha <span class="${dados.fosforo < 15 ? 'badge-error' : 'badge-success'}">${dados.fosforo < 15 ? 'Baixo' : 'Adequado'}</span></li>
                    <li>Potássio (K): ${dados.potassio} kg/ha <span class="${dados.potassio < 40 ? 'badge-error' : 'badge-success'}">${dados.potassio < 40 ? 'Baixo' : 'Adequado'}</span></li>
                  </ul>
                </div>
                
                <div class="diagnostico-col">
                  <h4>Características Físicas</h4>
                  <ul>
                    <li>pH: ${dados.ph} <span class="${ph < 5.5 || ph > 7.5 ? 'badge-error' : 'badge-success'}">${ph < 5.5 ? 'Ácido' : ph > 7.5 ? 'Alcalino' : 'Ideal'}</span></li>
                    <li>Umidade: ${dados.umidade}% <span class="${umidade < 40 || umidade > 80 ? 'badge-warning' : 'badge-success'}">${umidade < 40 ? 'Baixa' : umidade > 80 ? 'Alta' : 'Adequada'}</span></li>
                    <li>Precipitação: ${dados.chuva} mm/mês</li>
                    <li>Temperatura: ${dados.temperatura}°C</li>
                  </ul>
                </div>
              </div>
              
              <h3>2. Recomendações Agrícolas</h3>
              <div class="recomendacoes-grid">
                <div class="recomendacao-col">
                  <h4>Culturas Recomendadas</h4>
                  <ul>
                    <li><strong>Principal:</strong> ${culturas.principal}</li>
                    <li><strong>Alternativa:</strong> ${culturas.alternativa}</li>
                    <li><strong>Outras opções:</strong> ${culturas.outras.join(', ')}</li>
                  </ul>
                  <p><strong>Época ideal de plantio:</strong> ${epocaPlantio}</p>
                </div>
                
                <div class="recomendacao-col">
                  <h4>Manejo e Correções</h4>
                  <ul>
                    ${recomendacoes.map(rec => `<li>${rec}</li>`).join('')}
                  </ul>
                </div>
              </div>
              
              <h3>3. Adubação Orgânica</h3>
              <p>Recomenda-se aplicação de 5-10 ton/ha de composto orgânico para melhorar a estrutura do solo.</p>
          `;
          
          // Adiciona informações do bioma se disponível
          if (dadosBioma) {
            respostaHTML += `
              <div class="bioma-info">
                <h3>4. Características do Bioma ${dados.regiao}</h3>
                <div class="bioma-grid">
                  <div class="bioma-col">
                    <h4>Clima</h4>
                    <ul>
                      <li><strong>Precipitação média:</strong> ${dadosBioma.caracteristicas.precipitacao_mm_ano} mm/ano</li>
                      <li><strong>Temperatura média:</strong> ${dadosBioma.caracteristicas.temperatura_media_c}°C</li>
                    </ul>
                  </div>
                  
                  <div class="bioma-col">
                    <h4>Solo Predominante</h4>
                    <ul>
                      <li><strong>Tipo:</strong> ${soloPrincipal.tipo || 'Não especificado'}</li>
                      <li><strong>Textura:</strong> ${soloPrincipal.textura || 'Não especificada'}</li>
                      ${soloPrincipal.ph_medio ? `<li><strong>pH médio:</strong> ${soloPrincipal.ph_medio}</li>` : ''}
                      ${texturaSolo ? `<li><strong>Retenção água:</strong> ${texturaSolo.caracteristicas.retencao_agua}</li>` : ''}
                    </ul>
                  </div>
                  
                  <div class="bioma-col">
                    <h4>Aptidão Agrícola</h4>
                    <p>${soloPrincipal.aptidao || 'Não especificada'}</p>
                  </div>
                </div>
              </div>
            `;
          }
          
          respostaHTML += `</div>`;
          
          conteudoResposta.innerHTML = respostaHTML;

          // Botão de copiar
          conteudoResposta.innerHTML += `
            <div style="text-align:center;margin-top:2em;">
              <button id="btn-copiar" style="background:#0078D7;color:white;border:none;padding:0.5em 1em;border-radius:4px;cursor:pointer;font-size:0.9em;">
                Copiar recomendações
              </button>
            </div>
          `;

          document.getElementById('btn-copiar').addEventListener('click', function() {
            const textoParaCopiar = document.getElementById('conteudoResposta').innerText;
            navigator.clipboard.writeText(textoParaCopiar).then(() => {
              const btn = this;
              const textoOriginal = btn.textContent;
              btn.textContent = 'Copiado!';
              btn.style.background = '#28a745';
              setTimeout(() => {
                btn.textContent = textoOriginal;
                btn.style.background = '#0078D7';
              }, 2000);
            });
          });

        } catch (e) {
          conteudoResposta.innerHTML = `
            <div style="color:#b00;background:#fff3f3;padding:1em;border-radius:6px;">
              <strong>Erro ao gerar recomendações.</strong>
              <p>${e.message || 'Por favor, tente novamente.'}</p>
            </div>
          `;
          console.error(e);
        } finally {
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('btn-text').textContent = 'Analisar Solo';
          document.getElementById('submit-btn').disabled = false;
        }
      }, 1500);
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Inicializa as máscaras e validações
      aplicarMascaraComVirgula('umidade', 100);
      aplicarMascaraComVirgula('ph', 14);
      mascaraChuva('chuva');

      limitarValor('nitrogenio', 0, 80);
      limitarValor('fosforo', 0, 80);
      limitarValor('potassio', 0, 80);
      limitarValor('temperatura', -25, 80);

      // Validação ao sair do campo
      document.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('blur', function() {
          validarCampo(this);
        });
      });

      // Botão de ajuda
      document.getElementById('btn-ajuda').addEventListener('click', function() {
        const tabela = document.getElementById('tabela-referencia');
        tabela.style.display = tabela.style.display === 'none' ? 'table' : 'none';
      });

      // Mostra informações do bioma selecionado
      document.getElementById('regiao').addEventListener('change', function() {
        const biomaSelecionado = this.value;
        const dados = getDadosBioma(biomaSelecionado);
        
        if (dados) {
          console.log(`Bioma selecionado: ${biomaSelecionado}`, dados);
        }
      });
    });
  </script>
</body>
</html>