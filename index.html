<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://github.com/liviacastro0/imgs/blob/main/logo.png?raw=true" type="image/png">
  <link rel="stylesheet" href="style.css">
  <title>Análise de Solo Agrícola - IA Especializada</title>
</head>

<body>
  <div class="container">
    <h1>Análise de Solo Agrícola Inteligente</h1>

    <form id="form-solo" onsubmit="return processarFormulario(event)">
      <div class="form-grid">
        <div class="form-group">
          <label for="nitrogenio">
            Nitrogênio (kg/ha)
            <span class="info-icon" title="Valor ideal: 20-50 kg/ha para maioria das culturas">i</span>
          </label>
          <input type="number" id="nitrogenio" name="nitrogenio" placeholder="Ex: 25" min="0" max="500" required />
          <span class="input-hint">Faixa: 0-500 kg/ha</span>
        </div>

        <div class="form-group">
          <label for="fosforo">
            Fósforo (kg/ha)
            <span class="info-icon" title="Valor ideal: 15-40 kg/ha para grãos">i</span>
          </label>
          <input type="number" id="fosforo" name="fosforo" placeholder="Ex: 15" min="0" max="500" required />
          <span class="input-hint">Faixa: 0-500 kg/ha</span>
        </div>

        <div class="form-group">
          <label for="potassio">
            Potássio (kg/ha)
            <span class="info-icon" title="Valor ideal: 40-80 kg/ha para frutíferas">i</span>
          </label>
          <input type="number" id="potassio" name="potassio" placeholder="Ex: 50" min="0" max="500" required />
          <span class="input-hint">Faixa: 0-500 kg/ha</span>
        </div>

        <div class="form-group">
          <label for="temperatura">
            Temperatura (°C)
            <span class="info-icon" title="Temperatura média anual do local">i</span>
          </label>
          <input type="text" id="temperatura" name="temperatura" placeholder="Ex: 23,5" required />
          <span class="input-hint">Formato: 00,0 (10°C a 80°C)</span>

        </div>

        <div class="form-group">
          <label for="umidade">
            Umidade (%)
            <span class="info-icon" title="Umidade relativa média do solo">i</span>
          </label>
          <input type="text" id="umidade" name="umidade" placeholder="Ex: 60,00" required />
          <span class="input-hint">Formato: 00,00 (0-100%)</span>
        </div>

        <div class="form-group">
          <label for="ph">
            pH do Solo
            <span class="info-icon" title="Escala de 0 (ácido) a 14 (alcalino)">i</span>
          </label>
          <input type="text" id="ph" name="ph" placeholder="Ex: 5,00" required />
          <span class="input-hint">Escala: 5,0 a 14,0 (1-2 casas decimais)</span>
        </div>
      </div>

      <div class="form-group">
        <label for="chuva">
          Precipitação (mm/mês)
          <span class="info-icon" title="Média mensal de chuva na região">i</span>
        </label>
        <input type="text" id="chuva" name="chuva" placeholder="Ex: 120,00" required />
        <span class="input-hint">Formato: 000,00</span>
      </div>

      <div class="form-group">
        <label for="regiao">
          Região/Clima
          <span class="info-icon" title="Selecione o bioma predominante">i</span>
        </label>
        <select id="regiao" name="regiao" required>
          <option value="">Selecione...</option>
          <option value="Amazônia">Amazônia</option>
          <option value="Cerrado">Cerrado</option>
          <option value="Mata Atlântica">Mata Atlântica</option>
          <option value="Caatinga">Caatinga</option>
          <option value="Pampa">Pampa</option>
          <option value="Pantanal">Pantanal</option>
        </select>
      </div>

      <div style="text-align: center; margin-top: 25px;">
        <button type="submit" id="submit-btn">
          <span id="btn-text">Analisar Solo</span>
          <span class="loading-spinner" id="spinner"></span>
        </button>
      </div>
    </form>

    <section id="respostaIA" class="resposta-ia" aria-live="polite" hidden>
      <h2>Recomendações Personalizadas</h2>
      <div id="conteudoResposta"></div>
    </section>
  </div>

  <script>
    let dadosBiomas = {};
    let todasCulturas = new Set();

    const texturasSolo = {
      "texturas": [
        {
          "tipo": "arenosa",
          "composicao": {
            "areia_percent": 85,
            "silte_percent": 10,
            "argila_percent": 5
          },
          "caracteristicas": {
            "retencao_agua": "baixa",
            "aereacao": "alta",
            "fertilidade": "baixa"
          }
        },
        {
          "tipo": "franco-arenosa",
          "composicao": {
            "areia_percent": 65,
            "silte_percent": 20,
            "argila_percent": 15
          },
          "caracteristicas": {
            "retencao_agua": "média",
            "aereacao": "média",
            "fertilidade": "média"
          }
        },
        {
          "tipo": "franco",
          "composicao": {
            "areia_percent": 40,
            "silte_percent": 40,
            "argila_percent": 20
          },
          "caracteristicas": {
            "retencao_agua": "boa",
            "aereacao": "boa",
            "fertilidade": "alta"
          }
        },
        {
          "tipo": "argilosa",
          "composicao": {
            "areia_percent": 20,
            "silte_percent": 30,
            "argila_percent": 50
          },
          "caracteristicas": {
            "retencao_agua": "alta",
            "aereacao": "baixa",
            "fertilidade": "média a alta"
          }
        }
      ]
    };

    async function carregarDadosBiomas() {
      const arquivos = [
        'dados/amaz.json',
        'dados/caatinga.json',
        'dados/cerrado.json',
        'dados/mataatlant.json',
        'dados/pampa.json',
        'dados/pantanal.json',
        'dados/texturasolo.json'
      ];

      try {
        const promises = arquivos.map(arquivo =>
          fetch(arquivo)
            .then(response => response.json())
            .then(data => {
              const nomeBioma = arquivo.split('/')[1].replace('.json', '');
              if (nomeBioma !== 'texturasolo') {
                dadosBiomas[data.bioma] = data;

                data.solos.forEach(solo => {
                  if (solo.aptidao) {
                    solo.aptidao.split(', ').forEach(cultura => {
                      todasCulturas.add(cultura);
                    });
                  }
                });
              }
              return data;
            })
        );

        await Promise.all(promises);

        console.log('Dados dos biomas carregados com sucesso:', dadosBiomas);
      } catch (error) {
        console.error('Erro ao carregar os dados dos biomas:', error);
      }
    }

    function getDadosBioma(bioma) {
      if (!bioma || !dadosBiomas[bioma]) return null;
      return dadosBiomas[bioma];
    }

    function getTexturaSolo(tipoTextura) {
      return texturasSolo.texturas.find(textura => textura.tipo === tipoTextura) || null;
    }

    function aplicarMascaraPH(campoId) {
      const campo = document.getElementById(campoId);

      campo.addEventListener('input', function () {
        let valor = campo.value.replace(/\D/g, '');

        valor = valor.slice(-4);

        while (valor.length < 4) {
          valor = '0' + valor;
        }

        const parteInteira = valor.slice(0, valor.length - 2);
        const parteDecimal = valor.slice(-2);
        campo.value = `${parseInt(parteInteira)},${parteDecimal}`;

        validarCampoPH(campo);
      });

      campo.addEventListener('blur', function () {
        let valor = parseFloat(campo.value.replace(',', '.'));

        if (isNaN(valor)) {
          campo.value = '5,00';
        } else {
          if (valor < 5) valor = 5;
          if (valor > 14) valor = 14;
          campo.value = valor.toFixed(2).replace('.', ',');
        }

        validarCampoPH(campo);
      });

      campo.addEventListener('keydown', function (e) {
        const permitidos = [8, 9, 13, 27, 37, 38, 39, 40];
        const numeros = (e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105);
        const comandos = (e.ctrlKey || e.metaKey) && [65, 67, 86, 88].includes(e.keyCode);
        if (!permitidos.includes(e.keyCode) && !numeros && !comandos) {
          e.preventDefault();
        }
      });
    }

    function validarCampoPH(campo) {
      const valor = parseFloat(campo.value.replace(',', '.'));

      if (isNaN(valor) || valor < 5 || valor > 14) {
        campo.classList.add("erro-validacao");
        campo.classList.remove("sucesso-validacao");
        return false;
      }

      campo.classList.remove("erro-validacao");
      campo.classList.add("sucesso-validacao");
      return true;
    }

    function aplicarMascaraComVirgula(campoId, maxValor) {
      const campo = document.getElementById(campoId);
      campo.addEventListener('input', function () {
        let valor = campo.value.replace(',', '').replace(/[^\d]/g, '');
        if (valor.length > 2) {
          valor = valor.slice(0, valor.length - 2) + ',' + valor.slice(-2);
        }
        campo.value = valor;
        const valorConvertido = parseFloat(campo.value.replace(',', '.'));
        if (valorConvertido > maxValor) {
          campo.value = maxValor.toFixed(2).replace('.', ',');
        }
        validarCampo(campo);
      });
    }
    function aplicarMascaraTemperatura(campoId, minValor, maxValor) {
      const campo = document.getElementById(campoId);

      campo.addEventListener('input', function () {
        let valor = campo.value.replace(',', '').replace(/[^\d]/g, '');

        if (valor.length > 1) {
          valor = valor.slice(0, valor.length - 1) + ',' + valor.slice(-1);
        }

        campo.value = valor;

        let valorConvertido = parseFloat(campo.value.replace(',', '.'));
        if (valorConvertido > maxValor) {
          campo.value = maxValor.toFixed(1).replace('.', ',');
        } else if (valorConvertido < minValor && !isNaN(valorConvertido)) {
          campo.value = minValor.toFixed(1).replace('.', ',');
        }

        validarCampo(campo);
      });

      campo.addEventListener('blur', function () {
        let valorConvertido = parseFloat(campo.value.replace(',', '.'));
        if (isNaN(valorConvertido)) {
          campo.value = minValor.toFixed(1).replace('.', ',');
        } else {
          if (valorConvertido > maxValor) valorConvertido = maxValor;
          if (valorConvertido < minValor) valorConvertido = minValor;
          campo.value = valorConvertido.toFixed(1).replace('.', ',');
        }
        validarCampo(campo);
      });
    }

    function mascaraChuva(campoId) {
      const campo = document.getElementById(campoId);
      campo.addEventListener('input', function () {
        let valor = campo.value.replace(/[^\d]/g, '');
        if (valor.length > 5) valor = valor.slice(0, 5);

        while (valor.length < 3) {
          valor = '0' + valor;
        }

        let parteInteira = valor.slice(0, valor.length - 2);
        let parteDecimal = valor.slice(-2);
        campo.value = `${parseInt(parteInteira)},${parteDecimal}`;
        validarCampo(campo);
      });
    }

    function limitarValor(campoId, min, max) {
      const campo = document.getElementById(campoId);
      campo.addEventListener('input', function () {
        let valor = parseInt(campo.value);
        if (isNaN(valor)) return;
        if (valor > max) campo.value = max;
        if (valor < min) campo.value = min;
        validarCampo(campo);
      });
    }

    function validarCampo(campo) {
      if (campo.value === "") {
        campo.classList.add("erro-validacao");
        campo.classList.remove("sucesso-validacao");
      } else {
        campo.classList.remove("erro-validacao");
        campo.classList.add("sucesso-validacao");
      }
    }

    function validarDadosAgricolas(dados) {
      const erros = [];

      if (dados.nitrogenio > 500 || dados.nitrogenio < 0) erros.push("Nitrogênio fora da faixa (0-500 kg/ha)");
      if (dados.fosforo > 500 || dados.fosforo < 0) erros.push("Fósforo fora da faixa (0-500 kg/ha)");
      if (dados.potassio > 500 || dados.potassio < 0) erros.push("Potássio fora da faixa (0-500 kg/ha)");
      if (dados.temperatura > 80 || dados.temperatura < 10) erros.push("Temperatura fora da faixa (10°C a 80°C)");

      const ph = parseFloat(dados.ph.replace(',', '.'));
      if (isNaN(ph) || ph < 5 || ph > 14) erros.push("pH inválido (deve estar entre 5,0 e 14,0)");

      const umidade = parseFloat(dados.umidade.replace(',', '.'));
      if (umidade < 0 || umidade > 100) erros.push("Umidade deve ser entre 0% e 100%");

      if (!dados.regiao) erros.push("Selecione uma região/clima");

      return erros;
    }

    function calcularCalagem(phAtual, phDesejado, textura) {
      const fatoresTextura = {
        "arenosa": 0.5,
        "franco-arenosa": 0.7,
        "franco": 1.0,
        "argilosa": 1.3
      };

      const fator = fatoresTextura[textura] || 1.0;
      const necessidade = (phDesejado - phAtual) * 2000 * fator;

      return Math.max(0, Math.round(necessidade));
    }

    function calcularAdubacaoNutriente(nutrienteAtual, nutrienteIdeal, fatorConversao = 1.0) {
      const deficiencia = nutrienteIdeal - nutrienteAtual;
      if (deficiencia <= 0) return 0;
      return Math.round(deficiencia * fatorConversao);
    }

    function getCulturasRecomendadas(bioma, ph, nutrientes) {
      const culturasBase = {
        "Amazônia": ["Cacau", "Açaí", "Guaraná", "Pupunha", "Mandioca"],
        "Cerrado": ["Soja", "Milho", "Algodão", "Sorgo", "Feijão"],
        "Mata Atlântica": ["Café", "Cana-de-açúcar", "Eucalipto", "Banana", "Citrus"],
        "Caatinga": ["Manga", "Uva irrigada", "Caju", "Goiaba", "Feijão-caupi"],
        "Pampa": ["Arroz", "Trigo", "Soja", "Pastagens", "Videiras"],
        "Pantanal": ["Arroz", "Pecuária", "Piscicultura", "Capim", "Pastagens"]
      };

      const phMinMax = {
        "Cacau": [5.0, 6.5],
        "Açaí": [4.5, 6.5],
        "Soja": [6.0, 7.0],
        "Milho": [5.8, 7.0],
        "Café": [5.5, 6.5],
        "Manga": [5.5, 7.5],
        "Arroz": [5.0, 7.0],
      };

      let culturasDisponiveis = culturasBase[bioma] || [];

      culturasDisponiveis.sort((a, b) => {
        const aPh = phMinMax[a] || [5.0, 7.0];
        const bPh = phMinMax[b] || [5.0, 7.0];

        const aDiff = Math.max(0, aPh[0] - ph) + Math.max(0, ph - aPh[1]);
        const bDiff = Math.max(0, bPh[0] - ph) + Math.max(0, ph - bPh[1]);

        return aDiff - bDiff;
      });

      return {
        principal: culturasDisponiveis[0] || "Soja",
        alternativa: culturasDisponiveis[1] || "Milho",
        outras: culturasDisponiveis.slice(2, 5) || ["Feijão", "Pastagens"]
      };
    }

    async function processarFormulario(event) {
      event.preventDefault();

      const dados = {
        nitrogenio: parseInt(document.getElementById('nitrogenio').value),
        fosforo: parseInt(document.getElementById('fosforo').value),
        potassio: parseInt(document.getElementById('potassio').value),
        temperatura: parseFloat(document.getElementById('temperatura').value.replace(',', '.')),
        umidade: document.getElementById('umidade').value,
        ph: document.getElementById('ph').value,
        chuva: document.getElementById('chuva').value,
        regiao: document.getElementById('regiao').value
      };

      const erros = validarDadosAgricolas(dados);
      if (erros.length > 0) {
        alert("Erros encontrados:\n\n" + erros.join("\n"));
        return false;
      }

      document.getElementById('spinner').style.display = 'inline-block';
      document.getElementById('btn-text').textContent = 'Processando...';
      document.getElementById('submit-btn').disabled = true;

      const respostaIA = document.getElementById("respostaIA");
      const conteudoResposta = document.getElementById("conteudoResposta");
      respostaIA.hidden = false;
      conteudoResposta.innerHTML = `
        <div style="text-align:center;margin:2em 0;">
          <div class="loader" style="display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;"></div>
          <p>Consultando especialista agrícola...</p>
        </div>
      `;

      setTimeout(() => {
        try {
          const dadosBioma = getDadosBioma(dados.regiao);
          const ph = parseFloat(dados.ph.replace(',', '.'));
          const umidade = parseFloat(dados.umidade.replace(',', '.'));
          const chuva = parseFloat(dados.chuva.replace(',', '.'));

          let soloPrincipal = dadosBioma?.solos?.[0] || {};
          if (dadosBioma?.solos?.length > 1) {
            soloPrincipal = dadosBioma.solos.reduce((prev, curr) => {
              const prevDiff = Math.abs((prev.ph_medio || 6.0) - ph);
              const currDiff = Math.abs((curr.ph_medio || 6.0) - ph);
              return prevDiff < currDiff ? prev : curr;
            });
          }

          const texturaSolo = getTexturaSolo(soloPrincipal.textura);

          const recomendacoes = [];

          if (ph < 5.5) {
            const phDesejado = 6.0;
            const calcario = calcularCalagem(ph, phDesejado, soloPrincipal.textura);
            recomendacoes.push(`Aplicação de ${calcario} kg/ha de calcário dolomítico para elevar pH de ${ph.toFixed(1)} para ${phDesejado.toFixed(1)}`);
          } else if (ph > 7.5) {
            recomendacoes.push("Solo alcalino, considerar aplicação de gesso agrícola (1-2 ton/ha) para reduzir sódio");
          }

          const N = calcularAdubacaoNutriente(dados.nitrogenio, 30, 1.5);
          if (N > 0) {
            recomendacoes.push(`Adubação nitrogenada: ${N} kg/ha de N (uréia: ${Math.round(N / 0.45)} kg/ha)`);
          }

          const P = calcularAdubacaoNutriente(dados.fosforo, 20, 1.8);
          if (P > 0) {
            recomendacoes.push(`Adubação fosfatada: ${P} kg/ha de P2O5 (superfosfato simples: ${Math.round(P / 0.18)} kg/ha)`);
          }

          const K = calcularAdubacaoNutriente(dados.potassio, 50, 1.2);
          if (K > 0) {
            recomendacoes.push(`Adubação potássica: ${K} kg/ha de K2O (cloreto de potássio: ${Math.round(K / 0.60)} kg/ha)`);
          }

          if (umidade < 40) {
            recomendacoes.push("Solo com baixa umidade, considerar irrigação complementar (20-30mm/semana)");
          } else if (umidade > 80) {
            recomendacoes.push("Solo com excesso de umidade, avaliar drenagem (valas ou camalhões)");
          }

          const culturas = getCulturasRecomendadas(dados.regiao, ph, {
            N: dados.nitrogenio,
            P: dados.fosforo,
            K: dados.potassio
          });

          let epocaPlantio = "Durante a estação chuvosa";
          if (dados.temperatura > 25) {
            epocaPlantio = "No início das chuvas (outubro/novembro)";
          } else if (dados.temperatura < 15) {
            epocaPlantio = "Na primavera (setembro/outubro)";
          }

          const prompt = `Você é um engenheiro agrônomo especializado em análise de solo. Com base nos dados abaixo, forneça:
1. Cultura principal recomendada e cultura alternativa (justifique com os parâmetros do solo)
2. Recomendações detalhadas para cada cultura:
   - Preparo do solo (correção de pH, adubação)
   - Exigências hídricas (intervalo de irrigação)
   - Controle de pragas/doenças mais comuns
   - Época ideal de plantio
3. Atenção a riscos: 
   - Exemplo: "Se o pH < 5.5, existe a necessidade de calagem"

Dados:
- Nitrogênio: ${dados.nitrogenio} kg/ha
- Fósforo: ${dados.fosforo} kg/ha
- Potássio: ${dados.potassio} kg/ha
- pH: ${dados.ph}
- Umidade: ${dados.umidade}%
- Temperatura média: ${dados.temperatura}°C
- Precipitação: ${dados.chuva} mm/mês
- Região: ${dados.regiao}

Responda em tópicos com linguagem técnica acessível.`;

          const key = "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";

          callOpenRouter(prompt, key).then(respostaIA => {
            let respostaHTML = `
              <div class="diagnostico-container">
                <h3>1. Diagnóstico do Solo</h3>
                <div class="diagnostico-grid">
                  <div class="diagnostico-col">
                    <h4>Nutrientes</h4>
                    <ul>
                      <li>Nitrogênio (N): ${dados.nitrogenio} kg/ha <span class="${dados.nitrogenio < 20 ? 'badge-error' : 'badge-success'}">${dados.nitrogenio < 20 ? 'Baixo' : 'Adequado'}</span></li>
                      <li>Fósforo (P): ${dados.fosforo} kg/ha <span class="${dados.fosforo < 15 ? 'badge-error' : 'badge-success'}">${dados.fosforo < 15 ? 'Baixo' : 'Adequado'}</span></li>
                      <li>Potássio (K): ${dados.potassio} kg/ha <span class="${dados.potassio < 40 ? 'badge-error' : 'badge-success'}">${dados.potassio < 40 ? 'Baixo' : 'Adequado'}</span></li>
                    </ul>
                  </div>
                  
                  <div class="diagnostico-col">
                    <h4>Características Físicas</h4>
                    <ul>
                      <li>pH: ${dados.ph} <span class="${ph < 5.5 || ph > 7.5 ? 'badge-error' : 'badge-success'}">${ph < 5.5 ? 'Ácido' : ph > 7.5 ? 'Alcalino' : 'Ideal'}</span></li>
                      <li>Umidade: ${dados.umidade}% <span class="${umidade < 40 || umidade > 80 ? 'badge-warning' : 'badge-success'}">${umidade < 40 ? 'Baixa' : umidade > 80 ? 'Alta' : 'Adequada'}</span></li>
                      <li>Precipitação: ${dados.chuva} mm/mês</li>
                      <li>Temperatura: ${dados.temperatura}°C</li>
                    </ul>
                  </div>
                </div>
                
                <h3>2. Recomendações Agrícolas</h3>
                <div class="recomendacoes-grid">
                  <div class="recomendacao-col">
                    <h4>Culturas Recomendadas</h4>
                    <ul>
                      <li><strong>Principal:</strong> ${culturas.principal}</li>
                      <li><strong>Alternativa:</strong> ${culturas.alternativa}</li>
                      <li><strong>Outras opções:</strong> ${culturas.outras.join(', ')}</li>
                    </ul>
                    <p><strong>Época ideal de plantio:</strong> ${epocaPlantio}</p>
                  </div>
                  
                  <div class="recomendacao-col">
                    <h4>Manejo e Correções</h4>
                    <ul>
                      ${recomendacoes.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                  </div>
                </div>
                
                <h3>3. Recomendações da IA Especializada</h3>
                <div class="ia-recomendacoes">
                  ${formatarRespostaAgricultura(respostaIA)}
                </div>
            `;

            if (dadosBioma) {
              respostaHTML += `
                <div class="bioma-info">
                  <h3>4. Características do Bioma ${dados.regiao}</h3>
                  <div class="bioma-grid">
                    <div class="bioma-col">
                      <h4>Clima</h4>
                      <ul>
                        <li><strong>Precipitação média:</strong> ${dadosBioma.caracteristicas.precipitacao_mm_ano} mm/ano</li>
                        <li><strong>Temperatura média:</strong> ${dadosBioma.caracteristicas.temperatura_media_c}°C</li>
                      </ul>
                    </div>
                    
                    <div class="bioma-col">
                      <h4>Solo Predominante</h4>
                      <ul>
                        <li><strong>Tipo:</strong> ${soloPrincipal.tipo || 'Não especificado'}</li>
                        <li><strong>Textura:</strong> ${soloPrincipal.textura || 'Não especificada'}</li>
                        ${soloPrincipal.ph_medio ? `<li><strong>pH médio:</strong> ${soloPrincipal.ph_medio}</li>` : ''}
                        ${texturaSolo ? `<li><strong>Retenção água:</strong> ${texturaSolo.caracteristicas.retencao_agua}</li>` : ''}
                      </ul>
                    </div>
                    
                    <div class="bioma-col">
                      <h4>Aptidão Agrícola</h4>
                      <p>${soloPrincipal.aptidao || 'Não especificada'}</p>
                    </div>
                  </div>
                </div>
              `;
            }

            respostaHTML += `</div>`;

            conteudoResposta.innerHTML = respostaHTML;

            conteudoResposta.innerHTML += `
              <div style="text-align:center;margin-top:2em;">
                <button id="btn-copiar" style="background:#0078D7;color:white;border:none;padding:0.5em 1em;border-radius:4px;cursor:pointer;font-size:0.9em;">
                  Copiar recomendações
                </button>
              </div>
            `;

            document.getElementById('btn-copiar').addEventListener('click', function () {
              const textoParaCopiar = document.getElementById('conteudoResposta').innerText;
              navigator.clipboard.writeText(textoParaCopiar).then(() => {
                const btn = this;
                const textoOriginal = btn.textContent;
                btn.textContent = 'Copiado!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                  btn.textContent = textoOriginal;
                  btn.style.background = '#0078D7';
                }, 2000);
              });
            });
          }).catch(error => {
            console.error("Erro na chamada da IA:", error);
            conteudoResposta.innerHTML += `
              <div style="color:#b00;background:#fff3f3;padding:1em;border-radius:6px;margin-top:1em;">
                <strong>Erro ao obter recomendações da IA:</strong>
                <p>${error.message || 'Por favor, tente novamente.'}</p>
              </div>
            `;
          });

        } catch (e) {
          conteudoResposta.innerHTML = `
            <div style="color:#b00;background:#fff3f3;padding:1em;border-radius:6px;">
              <strong>Erro ao gerar recomendações.</strong>
              <p>${e.message || 'Por favor, tente novamente.'}</p>
            </div>
          `;
          console.error(e);
        } finally {
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('btn-text').textContent = 'Analisar Solo';
          document.getElementById('submit-btn').disabled = false;
        }
      }, 1500);
    }

    async function callOpenRouter(prompt, key) {
      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + key,
          "Content-Type": "application/json",
          "HTTP-Referer": window.location.href,
          "X-Title": "Análise de Solo Agrícola - IA Especializada"
        },
        body: JSON.stringify({
          model: "openrouter/cypher-alpha:free",
          temperature: 0.5,
          max_tokens: 2000,
          messages: [{ role: "user", content: prompt }]
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error?.message || "Erro na API");
      }

      const data = await response.json();
      return data.choices?.[0]?.message?.content || "Sem resposta da IA.";
    }

    function formatarRespostaAgricultura(texto) {
      texto = texto.replace(/\*\*/g, '')
        .replace(/#{1,6}/g, '')
        .replace(/`/g, '');

      const linhas = texto.split('\n').filter(linha => linha.trim() !== '');

      let html = '<div class="resposta-container">';

      for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i].trim();

        if (/^\d+\.\s/.test(linha)) {
          if (i > 0) html += '</div><div class="resposta-secao">';
          html += `<h4 class="resposta-titulo">${linha}</h4>`;
        }
        else if (/:$/.test(linha)) {
          html += `<p class="resposta-subtitulo">${linha}</p>`;
        }
        else if (linha.includes('---')) {
          html += `<hr class="resposta-divisor">`;
        }
        else {
          html += `<p class="resposta-texto">${linha}</p>`;
        }
      }

      return html + '</div>';
    }

    document.addEventListener('DOMContentLoaded', function () {
      carregarDadosBiomas();

      aplicarMascaraComVirgula('umidade', 100);
      aplicarMascaraPH('ph', 2, 14, 0);
      mascaraChuva('chuva');

      limitarValor('nitrogenio', 0, 500);
      limitarValor('fosforo', 0, 500);
      limitarValor('potassio', 0, 500);
      aplicarMascaraTemperatura('temperatura', 0, 80);

      document.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('blur', function () {
          if (input.id === 'ph') {
            validarCampoPH(input);
          } else {
            validarCampo(input);
          }
        });
      });

      document.getElementById('regiao').addEventListener('change', function () {
        const biomaSelecionado = this.value;
        const dados = getDadosBioma(biomaSelecionado);

        if (dados) {
          console.log(`Bioma selecionado: ${biomaSelecionado}`, dados);
        }
      });
    });
  </script>
</body>

</html>